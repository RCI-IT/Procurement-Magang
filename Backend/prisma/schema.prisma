generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PermintaanLapangan {
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  nomor              String              @unique
  tanggal            DateTime
  lokasi             String
  picLapangan        String
  status             PermintaanStatus    @default(PENDING)
  isConfirmed        Boolean             @default(false)
  isReceived         Boolean             @default(false)
  keterangan         String?
  id                 Int                 @id @default(autoincrement())
  userId             Int?
  confirmationOrders ConfirmationOrder[]
  detail             PermintaanDetails[]
  user               User?               @relation(fields: [userId], references: [id])
}

model PurchaseOrder {
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  nomorPO             String            @unique
  tanggalPO           DateTime
  lokasiPO            String
  keterangan          String?
  id                  Int               @id @default(autoincrement())
  confirmationOrderId Int               @unique
  userId              Int?
  purchaseDetails     PurchaseDetails[]
  confirmationOrder   ConfirmationOrder @relation("COToPO", fields: [confirmationOrderId], references: [id], onDelete: Cascade)
  user                User?             @relation(fields: [userId], references: [id])
}

model PurchaseDetails {
  qty             Int
  code            String
  satuan          String
  keterangan      String?
  status          POStatus      @default(IN_PROGRESS)
  id              Int           @id @default(autoincrement())
  purchaseOrderId Int
  materialId      Int
  material        Materials     @relation(fields: [materialId], references: [id], onDelete: Cascade)
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
}

model ConfirmationOrder {
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  nomorCO             String                @unique
  tanggalCO           DateTime
  lokasiCO            String
  keterangan          String?
  status              COStatus              @default(PENDING)
  id                  Int                   @id @default(autoincrement())
  userId              Int?
  permintaanId        Int?
  confirmationDetails ConfirmationDetails[]
  permintaan          PermintaanLapangan?   @relation(fields: [permintaanId], references: [id])
  user                User?                 @relation(fields: [userId], references: [id])
  purchaseOrder       PurchaseOrder?        @relation("COToPO")
}

model ConfirmationDetails {
  qty                 Int
  code                String
  keterangan          String?
  satuan              String
  status              DetailStatus      @default(PENDING)
  mention             String?
  id                  Int               @id @default(autoincrement())
  confirmationOrderId Int
  materialId          Int
  confirmationOrder   ConfirmationOrder @relation(fields: [confirmationOrderId], references: [id], onDelete: Cascade)
  material            Materials         @relation(fields: [materialId], references: [id], onDelete: Cascade)
}

model PermintaanDetails {
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  qty          Int
  satuan       String
  mention      String?
  code         String
  keterangan   String?
  status       PLDStatus          @default(PENDING)
  id           Int                @id @default(autoincrement())
  permintaanId Int
  materialName String
  permintaan   PermintaanLapangan @relation(fields: [permintaanId], references: [id], onDelete: Cascade)
}

model Materials {
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  image               String?
  name                String
  description         String
  id                  Int                   @id @default(autoincrement())
  price               Int
  categoryId          Int
  vendorId            Int
  code                String                @unique
  confirmationDetails ConfirmationDetails[]
  category            Categories            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  vendor              Vendors               @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  PurchaseDetails     PurchaseDetails[]
}

model Categories {
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  name      String      @unique
  id        Int         @id @default(autoincrement())
  materials Materials[]
}

model Vendors {
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  name      String
  address   String?
  city      String?
  phone     String?
  id        Int         @id @default(autoincrement())
  materials Materials[]
}

model User {
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  username           String               @unique
  password           String
  email              String               @unique
  fullName           String
  role               UserRole             @default(USER_LAPANGAN)
  id                 Int                  @id @default(autoincrement())
  confirmationOrders ConfirmationOrder[]
  permintaans        PermintaanLapangan[]
  PurchaseOrder      PurchaseOrder[]
  SignedBy           SignedBy[]
  SigningAuthority   SigningAuthority[]
}

model SignedBy {
  id           String     @id @default(uuid())
  signedFileId String
  userId       Int
  role         String
  signature    String
  createdAt    DateTime   @default(now())
  SignedFile   SignedFile @relation(fields: [signedFileId], references: [id])
  User         User       @relation(fields: [userId], references: [id])
}

model SignedFile {
  id        String     @id @default(uuid())
  type      FileType
  relatedId Int
  createdAt DateTime   @default(now())
  SignedBy  SignedBy[]

  @@unique([type, relatedId])
}

model SigningAuthority {
  id       String      @id @default(uuid())
  userId   Int
  fileType FileType
  role     SigningRole
  User     User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fileType, role])
}

enum PermintaanStatus {
  PENDING
  APPROVED
  REJECTED
  IN_PROGRESS
  CLOSED
  CANCELLED
  READ
}

enum COStatus {
  PENDING
  CLOSED
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  CANCELLED
  IN_PROGRESS
  READ
}

enum POStatus {
  PENDING
  CLOSED
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  CANCELLED
  IN_PROGRESS
  READ
}

enum UserRole {
  ADMIN
  USER_PURCHASE
  USER_LAPANGAN
}

enum DetailStatus {
  PENDING
  APPROVED
  REJECTED
  IN_PROGRESS
  CLOSED
  CANCELLED
  READ
  ACC
}

enum PLDStatus {
  PENDING
  APPROVED
  REJECTED
  IN_PROGRESS
  CLOSED
  CANCELLED
  READ
}

enum FileType {
  PERMINTAAN_LAPANGAN
  CONFIRMATION_ORDER
  PURCHASE_ORDER
  PL
  CO
  PO
}

enum SigningRole {
  ENGINEER_REQUESTER
  ENGINEER_CHECKER
  PIC_LAPANGAN
  PURCHASING
  SITE_MANAGER
  VENDOR
  FINANCE
  DIREKSI
}
