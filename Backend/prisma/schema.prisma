generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["enum", "public", "auth", "project", "material", "procurement", "approval"]
}

/////////////////////////
// ENUM
/////////////////////////

enum ProjectStatus {
  PLANNING
  ONGOING
  HOLD
  COMPLETED
  CANCELLED

  @@schema("enum")
}

// enum Status {
//   PLANNING
//   ACTIVE
//   PENDING
//   HOLD
//   APPROVED
//   REJECTED
//   IN_PROGRESS // gunakan ini, hindari "PROCESSING" supaya tidak ambigu
//   ONGOING
//   CLOSED
//   CANCELLED
//   READ
//   COMPLETED
//   ACC // jika tetap dibutuhkan
// }

enum MRStatus {
  DRAFT
  PENDING
  PARTIAL
  APPROVED
  REJECTED
  COMPLETED

  @@schema("enum")
}

enum BoqType {
  MATERIAL
  LABOR
  EQUIPMENT
  OTHER

  @@schema("enum")
}

/////////////////////////
// Authentifikasi
/////////////////////////

model AuthUser {
  id        String         @id @default(uuid())
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  username  String         @unique
  password  String
  email     String         @unique
  roles     AuthUserRole[]

  employeeId       String?
  // employee   HREmployee? @relation(fields: [employeeId], references: [id])
  // SignedBy           SignedBy[]
  // SigningAuthority   SigningAuthority[]
  refreshTokens    RefreshToken[]
  materialRequests MaterialRequest[]
  purchase         Purchase[]
  approvalRecords  ApprovalRecord[]
  deliveries       Delivery[]
  goodsReceipts    GoodsReceipt[]

  @@schema("auth")
}

model AuthRole {
  id        String   @id @default(uuid())
  roleName  String   @unique
  createdAt DateTime @default(now())

  users AuthUserRole[]

  @@schema("auth")
}

model AuthUserRole {
  id     String @id @default(uuid())
  userId String
  roleId String

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  role AuthRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@schema("auth")
}

model RefreshToken {
  id        String  @id @default(uuid())
  token     String  @unique
  userId    String
  userAgent String? // device
  ipAddress String? // optional

  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  user AuthUser @relation(fields: [userId], references: [id])

  @@schema("auth")
}

/////////////////////////////////////////////////////
// PROJECT SERVICE
/////////////////////////////////////////////////////

model Project {
  id          String          @id @default(uuid())
  projectName String
  code        String
  location    String
  owner       String
  contractNo  String
  startDate   DateTime        @db.Date
  endDate     DateTime        @db.Date
  members     ProjectMember[]
  // projectManager String

  // status         ProjectStatus
  // assignments    ProjectAssignment[]
  // purchaseOrders PurchaseOrder[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  rabs             Rab[]
  materialRequests MaterialRequest[]
  purchase         Purchase[]

  @@schema("project")
}

model ProjectRole {
  id       String          @id @default(uuid())
  roleName String          @unique
  members  ProjectMember[]
  approval ApprovalFlow[]

  @@schema("project")
}

model ProjectMember {
  id         String   @id @default(uuid())
  employeeId String
  projectId  String
  roleId     String
  joinedAt   DateTime @default(now())

  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  role    ProjectRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  rab     Rab[]

  @@unique([projectId, employeeId, roleId])
  @@schema("project")
}

/////////////////////////
// RAB (Budget) + BUDGET ITEMS (BOQ)
/////////////////////////

/// RAB as Budget header
model Rab {
  id          String   @id @default(cuid())
  projectId   String
  name        String? // contoh: "RAB Pekerjaan Pondasi"
  description String?
  totalBudget Decimal? @db.Decimal(18, 2) // dihitung dari BOQ
  createdBy   String
  createdAt   DateTime @default(now())

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  created ProjectMember @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  boqs    Boq[]

  @@schema("project")
}

model Boq {
  id          String   @id @default(cuid())
  rabId       String
  materialId  String? // opsional jika item berupa pekerjaan non-material
  description String // contoh: "Pekerjaan galian tanah" atau "Semen"
  // unit        String?
  quantity    Decimal?
  price       Decimal? @db.Decimal(18, 2)
  // total       Decimal?    @db.Decimal(18,2) // quantity * price
  type        String

  rab      Rab                   @relation(fields: [rabId], references: [id], onDelete: Cascade)
  material Material?             @relation(fields: [materialId], references: [id])
  boqType  boqType               @relation(fields: [type], references: [id], onDelete: Cascade)
  mrItems  MaterialRequestItem[]

  @@schema("project")
}

model boqType {
  id   String @id @default(uuid())
  type String

  boqType Boq[]

  @@schema("project")
}

/////////////////////////
// MATERIAL CATALOG
/////////////////////////
model Categories {
  id        String     @id @default(uuid())
  name      String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  materials Material[]

  @@schema("material")
}

model Material {
  id          String   @id @default(uuid())
  name        String
  description String?
  unit        String   @default("pcs")
  code        String   @unique
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  image                MaterialImage[]
  category             Categories            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  materialVendors      MaterialVendors[]
  materialRequestItems MaterialRequestItem[]
  boqs                 Boq[]

  @@schema("material")
}

model MaterialImage {
  id         String   @id @default(uuid())
  materialId String
  filename   String
  createdAt  DateTime @default(now())

  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@schema("material")
}

model Vendor {
  id        String   @id @default(uuid())
  name      String
  address   String?
  city      String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materialVendors MaterialVendors[]
  purchases       Purchase[]

  @@schema("material")
}

model MaterialVendors {
  id         String   @id @default(uuid())
  price      Decimal  @db.Decimal(12, 2)
  materialId String
  vendorId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  vendor   Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([materialId, vendorId]) // satu vendor hanya boleh punya satu harga untuk 1 material
  @@schema("material")
}

/////////////////////////////////////////////////////
// PROCUREMENT SERVICE
/////////////////////////////////////////////////////

model MaterialRequest {
  id        String  @id @default(uuid())
  projectId String
  userId    String? // pembuat MR (AuthUser)

  requestDate DateTime

  // STATUS FLOW:
  // PENDING -> APPROVED -> PROCESSING -> DELIVERED -> RECEIVED -> COMPLETED
  status      String  @default("PENDING")
  lokasi      String?
  picLapangan String?
  note        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creator AuthUser?             @relation(fields: [userId], references: [id])
  project Project               @relation(fields: [projectId], references: [id])
  items   MaterialRequestItem[]

  // TIMESTAMPS FOR FLOW
  approvedAt DateTime?
  // approval universaI (MR → Approval by documentId/documentType)
  // approvals  ApprovalRecord[] @relation("MR_approvals")

  // pengiriman barang
  // deliveries MRDelivery[]

  @@schema("procurement")
}

model MaterialRequestItem {
  id         String @id @default(uuid())
  mRequestId String
  // material yang diminta (WAJIB dari database)
  materialId String
  // harus berasal dari BOQ yang terkait
  boqId      String

  qtyRequested Decimal
  // unit         String
  // code
  notes        String?

  mr       MaterialRequest @relation(fields: [mRequestId], references: [id], onDelete: Cascade)
  material Material        @relation(fields: [materialId], references: [id])
  boq      Boq             @relation(fields: [boqId], references: [id], onDelete: Restrict)

  poLinks    PurchaseItem[]
  deliveries DeliveryItem[]
  receipts   GRItem[]

  @@schema("procurement")
}

model Purchase {
  id        String @id @default(uuid())
  createdBy String
  vendorId  String
  projectId String

  poDate DateTime
  note   String?

  createdAt DateTime @default(now())

  creator AuthUser @relation(fields: [createdBy], references: [id])
  vendor  Vendor   @relation(fields: [vendorId], references: [id])
  project Project  @relation(fields: [projectId], references: [id])

  items      PurchaseItem[]
  deliveries Delivery[]

  @@schema("procurement")
}

model PurchaseItem {
  id       String  @id @default(uuid())
  mrItemId String
  poId     String
  qty      Decimal
  price    Decimal @db.Decimal(18, 2)

  mrItem MaterialRequestItem @relation(fields: [mrItemId], references: [id])
  po     Purchase            @relation(fields: [poId], references: [id])

  @@schema("procurement")
}

/////////////////////////////////////////////////////
// DELIVERY
/////////////////////////////////////////////////////

model Delivery {
  id           String   @id @default(uuid())
  poId         String
  deliveredBy  String? // AuthUser
  deliveryDate DateTime
  note         String?

  po           Purchase  @relation(fields: [poId], references: [id])
  deliveryUser AuthUser? @relation(fields: [deliveredBy], references: [id])

  items         DeliveryItem[]
  goodsReceipts GoodsReceipt[]

  @@schema("procurement")
}

model DeliveryItem {
  id         String  @id @default(uuid())
  deliveryId String
  mrItemId   String
  qty        Decimal

  delivery Delivery            @relation(fields: [deliveryId], references: [id])
  mrItem   MaterialRequestItem @relation(fields: [mrItemId], references: [id])

  @@schema("procurement")
}

model GoodsReceipt {
  id         String   @id @default(uuid())
  deliveryId String
  receivedBy String?
  receivedAt DateTime

  delivery Delivery  @relation(fields: [deliveryId], references: [id])
  receiver AuthUser? @relation(fields: [receivedBy], references: [id])

  items GRItem[]

  @@schema("procurement")
}

model GRItem {
  id       String  @id @default(uuid())
  grId     String
  mrItemId String
  qty      Decimal

  gr     GoodsReceipt        @relation(fields: [grId], references: [id])
  mrItem MaterialRequestItem @relation(fields: [mrItemId], references: [id])

  @@schema("procurement")
}

/////////////////////////////////////////////////////
// APPROVAL
/////////////////////////////////////////////////////

model ApprovalFlow {
  id            String @id @default(uuid())
  module        String // "MR", "ITEM", "PO", "GR", etc.
  level         Int // urutan approval
  projectRoleId String
  // approverRole String // role yang berhak approve

  projectRole ProjectRole      @relation(fields: [projectRoleId], references: [id])
  records     ApprovalRecord[]

  @@schema("approval")
}

model ApprovalRecord {
  id String @id @default(uuid())

  module String // MR, MR_ITEM, PO, GR, etc.
  refId  String // id MR, id MRItem, id PO, dll

  approvalFlowId String?
  approvedBy     String? // AuthUser
  approvedAt     DateTime?
  status         String    @default("PENDING")
  // PENDING, APPROVED, REJECTED

  flow     ApprovalFlow? @relation(fields: [approvalFlowId], references: [id])
  approver AuthUser?     @relation(fields: [approvedBy], references: [id])

  @@index([module, refId])
  @@schema("approval")
}

// model ProjectAssignment {
//   id            String      @id @default(cuid())
//   employeeId    String // Foreign key dari backend karyawan
//   projectId     String
//   roleInProject ProjectRole @relation(fields: [projectRoleId], references: [id])

//   project       Project  @relation(fields: [projectId], references: [id])
//   createdAt     DateTime @default(now())
//   projectRoleId String

//   @@unique([employeeId, projectId])
//   @@schema("procurement")
// }

// model ConfirmationOrder {
//   createdAt           DateTime              @default(now())
//   updatedAt           DateTime              @updatedAt
//   nomorCO             String                @unique
//   tanggalCO           DateTime
//   keterangan          String?
//   status              Status                @default(PENDING)
//   id                  Int                   @id @default(autoincrement())
//   userId              Int?
//   permintaanId        Int?
//   vendorId            Int?
//   confirmationDetails ConfirmationDetails[]
//   permintaan          PermintaanLapangan?   @relation(fields: [permintaanId], references: [id])
//   user                User?                 @relation(fields: [userId], references: [id])
//   purchaseOrder       PurchaseOrder?        @relation("COToPO")
//   vendor              Vendors?              @relation(fields: [vendorId], references: [id]) // ✅ Tambahan  
// }

// model PurchaseOrder {
//   id                  Int               @id @default(autoincrement())
//   createdAt           DateTime          @default(now())
//   updatedAt           DateTime          @updatedAt
//   nomorPO             String            @unique
//   tanggalPO           DateTime
//   keterangan          String?
//   confirmationOrderId Int               @unique
//   userId              Int? // ✅ Tambahan
//   purchaseDetails     PurchaseDetails[]
//   confirmationOrder   ConfirmationOrder @relation("COToPO", fields: [confirmationOrderId], references: [id], onDelete: Cascade)
//   user                User?             @relation(fields: [userId], references: [id])
//   projectId           String?
//   Project             Project?          @relation(fields: [projectId], references: [id])
// }

// model ConfirmationDetails {
//   qty                 Int
//   code                String
//   keterangan          String?
//   satuan              String
//   status              Status            @default(PENDING)
//   mention             String?
//   id                  Int               @id @default(autoincrement())
//   confirmationOrderId Int
//   materialId          Int
//   confirmationOrder   ConfirmationOrder @relation(fields: [confirmationOrderId], references: [id], onDelete: Cascade)
//   material            Materials         @relation(fields: [materialId], references: [id], onDelete: Cascade)
// }

// model PurchaseDetails {
//   qty             Int
//   code            String
//   satuan          String
//   keterangan      String?
//   status          Status        @default(IN_PROGRESS)
//   id              Int           @id @default(autoincrement())
//   purchaseOrderId Int
//   materialId      Int
//   material        Materials     @relation(fields: [materialId], references: [id], onDelete: Cascade)
//   purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
// }

// model SignedBy {
//   id           String     @id @default(uuid())
//   signedFileId String
//   userId       Int
//   role         String
//   signature    String
//   createdAt    DateTime   @default(now())
//   SignedFile   SignedFile @relation(fields: [signedFileId], references: [id])
//   User         User       @relation(fields: [userId], references: [id])
// }

// model SignedFile {
//   id        String     @id @default(uuid())
//   type      FileType
//   relatedId Int
//   createdAt DateTime   @default(now())
//   SignedBy  SignedBy[]

//   @@unique([type, relatedId])
// }

// model SigningAuthority {
//   id       String      @id @default(uuid())
//   userId   Int
//   fileType FileType
//   role     SigningRole
//   User     User        @relation(fields: [userId], references: [id], onDelete: Cascade)

//   @@unique([userId, fileType, role])
// }

// enum FileType {
//   PERMINTAAN_LAPANGAN
//   CONFIRMATION_ORDER
//   PURCHASE_ORDER
// }

// enum SigningRole {
//   ENGINEER_REQUESTER
//   ENGINEER_CHECKER
//   LOGISTIC
//   PIC_LAPANGAN
//   PURCHASING
//   SITE_MANAGER
//   VENDOR
//   FINANCE
//   DIREKSI
// }
