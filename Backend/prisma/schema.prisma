generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  username           String               @unique
  password           String
  email              String               @unique
  fullName           String
  role               UserRole             @default(USER_LAPANGAN)
  id                 Int                  @id @default(autoincrement())
  confirmationOrders ConfirmationOrder[]
  permintaans        PermintaanLapangan[]
  PurchaseOrder      PurchaseOrder[]
  SignedBy           SignedBy[]
  SigningAuthority   SigningAuthority[]
}

model Project {
  id             String   @id @default(uuid())
  name           String
  code           String
  location       String
  owner          String
  contractNo     String
  startDate      DateTime @db.Date
  endDate        DateTime @db.Date
  projectManager String

  status           ProjectStatus
  assignments      ProjectAssignment[]
  budgetItem       BudgetItem[]
  budgetCategories BudgetCategory[]
  fieldRequests    PermintaanLapangan[]
  purchaseOrders   PurchaseOrder[]
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
}

model ProjectAssignment {
  id            String      @id @default(cuid())
  employeeId    String // Foreign key dari backend karyawan
  projectId     String
  roleInProject ProjectRole

  project   Project  @relation(fields: [projectId], references: [id])
  createdAt DateTime @default(now())

  @@unique([employeeId, projectId])
}

model BudgetCategory {
  id        String           @id @default(uuid())
  name      String
  parentId  String?
  projectId String?
  parent    BudgetCategory?  @relation("CategoryParent", fields: [parentId], references: [id])
  children  BudgetCategory[] @relation("CategoryParent")

  items   BudgetItem[]
  Project Project?     @relation(fields: [projectId], references: [id])
}

model BudgetItem {
  id          String  @id @default(cuid())
  projectId   String
  categoryId  String?
  // budgetCode  String  @unique
  description String // Contoh: Rental Mobil Operasional
  unit        String? // Contoh: Unit, Org, Lot, Bln
  quantity    Float? // Contoh: 2
  frequency   Int? // Contoh: 2 Bln
  duration    Int? // Contoh: 4 Bln (lama waktu)
  price       Int?

  project        Project         @relation(fields: [projectId], references: [id])
  budgetCategory BudgetCategory? @relation(fields: [categoryId], references: [id])

  @@unique([projectId, categoryId, description], name: "unique_item_per_project")
}

model PermintaanLapangan {
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  nomor              String              @unique
  tanggal            DateTime
  lokasi             String
  picLapangan        String
  status             Status              @default(PENDING)
  isConfirmed        Boolean             @default(false)
  isReceived         Boolean             @default(false)
  keterangan         String?
  id                 Int                 @id @default(autoincrement())
  userId             Int?
  projectId          String?
  confirmationOrders ConfirmationOrder[]
  detail             PermintaanDetails[]
  user               User?               @relation(fields: [userId], references: [id])
  project            Project?            @relation(fields: [projectId], references: [id])
}

model ConfirmationOrder {
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  nomorCO             String                @unique
  tanggalCO           DateTime
  keterangan          String?
  status              Status                @default(PENDING)
  id                  Int                   @id @default(autoincrement())
  userId              Int?
  permintaanId        Int?
  vendorId            Int?
  confirmationDetails ConfirmationDetails[]
  permintaan          PermintaanLapangan?   @relation(fields: [permintaanId], references: [id])
  user                User?                 @relation(fields: [userId], references: [id])
  purchaseOrder       PurchaseOrder?        @relation("COToPO")
  vendor              Vendors?              @relation(fields: [vendorId], references: [id]) // ✅ Tambahan  
}

model PurchaseOrder {
  id                  Int               @id @default(autoincrement())
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  nomorPO             String            @unique
  tanggalPO           DateTime
  keterangan          String?
  confirmationOrderId Int               @unique
  userId              Int? // ✅ Tambahan
  purchaseDetails     PurchaseDetails[]
  confirmationOrder   ConfirmationOrder @relation("COToPO", fields: [confirmationOrderId], references: [id], onDelete: Cascade)
  user                User?             @relation(fields: [userId], references: [id])
  projectId           String?
  Project             Project?          @relation(fields: [projectId], references: [id])
}

model ConfirmationDetails {
  qty                 Int
  code                String
  keterangan          String?
  satuan              String
  status              Status            @default(PENDING)
  mention             String?
  id                  Int               @id @default(autoincrement())
  confirmationOrderId Int
  materialId          Int
  confirmationOrder   ConfirmationOrder @relation(fields: [confirmationOrderId], references: [id], onDelete: Cascade)
  material            Materials         @relation(fields: [materialId], references: [id], onDelete: Cascade)
}

model PermintaanDetails {
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  qty          Int
  satuan       String
  mention      String?
  code         String
  keterangan   String?
  status       Status             @default(PENDING)
  id           Int                @id @default(autoincrement())
  permintaanId Int
  materialName String
  permintaan   PermintaanLapangan @relation(fields: [permintaanId], references: [id], onDelete: Cascade)
}

model PurchaseDetails {
  qty             Int
  code            String
  satuan          String
  keterangan      String?
  status          Status        @default(IN_PROGRESS)
  id              Int           @id @default(autoincrement())
  purchaseOrderId Int
  materialId      Int
  material        Materials     @relation(fields: [materialId], references: [id], onDelete: Cascade)
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
}

model Materials {
  id                  Int                   @id @default(autoincrement())
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  image               String?
  name                String
  unit                String                @default("pcs")
  description         String
  price               Int
  categoryId          Int
  vendorId            Int
  code                String                @unique
  confirmationDetails ConfirmationDetails[]
  category            Categories            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  vendor              Vendors               @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  PurchaseDetails     PurchaseDetails[]
}

model Categories {
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  name      String      @unique
  id        Int         @id @default(autoincrement())
  materials Materials[]
}

model Vendors {
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  name         String
  address      String?
  city         String?
  phone        String?
  id           Int                 @id @default(autoincrement())
  materials    Materials[]
  ConfirmOrder ConfirmationOrder[]
}

model SignedBy {
  id           String     @id @default(uuid())
  signedFileId String
  userId       Int
  role         String
  signature    String
  createdAt    DateTime   @default(now())
  SignedFile   SignedFile @relation(fields: [signedFileId], references: [id])
  User         User       @relation(fields: [userId], references: [id])
}

model SignedFile {
  id        String     @id @default(uuid())
  type      FileType
  relatedId Int
  createdAt DateTime   @default(now())
  SignedBy  SignedBy[]

  @@unique([type, relatedId])
}

model SigningAuthority {
  id       String      @id @default(uuid())
  userId   Int
  fileType FileType
  role     SigningRole
  User     User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fileType, role])
}

enum Status {
  ACTIVE
  PENDING
  APPROVED
  REJECTED
  IN_PROGRESS // gunakan ini, hindari "PROCESSING" supaya tidak ambigu
  CLOSED
  CANCELLED
  READ
  COMPLETED
  ACC // jika tetap dibutuhkan
}

enum UserRole {
  ADMIN
  USER_PURCHASE
  USER_LAPANGAN
}

enum FileType {
  PERMINTAAN_LAPANGAN
  CONFIRMATION_ORDER
  PURCHASE_ORDER
}

enum SigningRole {
  ENGINEER_REQUESTER
  ENGINEER_CHECKER
  LOGISTIC
  PIC_LAPANGAN
  PURCHASING
  SITE_MANAGER
  VENDOR
  FINANCE
  DIREKSI
}

enum ProjectStatus {
  BERJALAN
  SELESAI
  TERTUNDA
  ONGOING
}

enum ProjectRole {
  PM
  PROCUREMENT
  STAFF
}
