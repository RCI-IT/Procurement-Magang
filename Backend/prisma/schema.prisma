generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model AuthUser {
  id        Int            @id @default(autoincrement())
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  username  String         @unique
  password  String
  email     String         @unique
  roles     AuthUserRole[]

  employeeId String?
  // employee   HREmployee? @relation(fields: [employeeId], references: [id])

  confirmationOrders ConfirmationOrder[]
  permintaans        PermintaanLapangan[]
  PurchaseOrder      PurchaseOrder[]
  SignedBy           SignedBy[]
  SigningAuthority   SigningAuthority[]
}

model AuthRole {
  id        String   @id @default(uuid())
  roleName  String   @unique
  createdAt DateTime @default(now())

  users AuthUserRole[]
}

model AuthUserRole {
  id     String @id @default(uuid())
  userId String
  roleId String

  user AuthUser @relation(fields: [userId], references: [id])
  role AuthRole @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
}

model RefreshToken {
  id        String  @id @default(uuid())
  token     String  @unique
  userId    String
  userAgent String? // device
  ipAddress String? // optional

  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  user AuthUser @relation(fields: [userId], references: [id])

  @@schema("auth")
}

/////////////////////////////////////////////////////
// PROJECT SERVICE
/////////////////////////////////////////////////////

model Project {
  id          String          @id @default(uuid())
  projectName String
  code        String
  location    String
  owner       String
  contractNo  String
  startDate   DateTime        @db.Date
  endDate     DateTime        @db.Date
  members     ProjectMember[]
  // projectManager String

  status           ProjectStatus
  assignments      ProjectAssignment[]
  budgetItem       BudgetItem[]
  budgetCategories BudgetCategory[]
  fieldRequests    PermintaanLapangan[]
  purchaseOrders   PurchaseOrder[]
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
}

model ProjectRole {
  id       String          @id @default(uuid())
  roleName String?
  members  ProjectMember[]
}

model ProjectMember {
  id         String   @id @default(uuid())
  employeeId String
  projectId  String
  roleId     String
  joinedAt   DateTime @default(now())

  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  role    ProjectRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([projectId,roleId])
}

/////////////////////////////////////////////////////
// BUDGET SERVICE (Replace Old RAB & BOQ with Prisma Version)
/////////////////////////////////////////////////////

model Rab {
  id          String   @id @default(uuid())
  projectId   String
  category    String?
  description String?
  totalBudget Float?
  createdBy   String?
  createdAt   DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  boqs    Boq[]
}

model Boq {
  id          String  @id @default(cuid())
  rabId       String
  description String?
  detail      String?
  unit        String?
  qty         Float?
  unitPrice   Float?
  total       Float?
  costType    String?

  rab      Rab               @relation(fields: [rabId], references: [id], onDelete: Cascade)
  requests MaterialRequest[]
}

/////////////////////////////////////////////////////
// PROCUREMENT SERVICE
/////////////////////////////////////////////////////

model MaterialRequest {
  id                 String              @id @default(uuid())
  boqId              String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  requestDate        DateTime
  requested_qty      Decimal?
  status             String?
  // nomor              String              @unique
  lokasi             String
  picLapangan        String
  isConfirmed        Boolean             @default(false)
  isReceived         Boolean             @default(false)
  keterangan         String?
  userId             Int?
  projectId          String?
  confirmationOrders ConfirmationOrder[]
  detail             PermintaanDetails[]
  user               AuthUser?               @relation(fields: [userId], references: [id])
  project            Project?            @relation(fields: [projectId], references: [id])
}

model Purchase {
  id            Int       @id @default(autoincrement())
  mr_id         Int
  vendor_id     Int
  purchase_date DateTime?
  qty_purchased Decimal?
  total_price   Decimal?
  created_at    DateTime? @default(now())

  mr     MaterialRequest @relation(fields: [mr_id], references: [id], onDelete: Cascade)
  vendor Vendor          @relation(fields: [vendor_id], references: [id], onDelete: Cascade)
}

model Vendors {
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  id           String              @id @default(uuid())
  name         String
  address      String?
  city         String?
  phone        String?
  materials    Materials[]
  ConfirmOrder ConfirmationOrder[]
}

model ProjectAssignment {
  id            String      @id @default(cuid())
  employeeId    String // Foreign key dari backend karyawan
  projectId     String
  roleInProject ProjectRole

  project   Project  @relation(fields: [projectId], references: [id])
  createdAt DateTime @default(now())

  @@unique([employeeId, projectId])
}

model BudgetCategory {
  id        String           @id @default(uuid())
  name      String
  parentId  String?
  projectId String?
  parent    BudgetCategory?  @relation("CategoryParent", fields: [parentId], references: [id])
  children  BudgetCategory[] @relation("CategoryParent")

  items   BudgetItem[]
  Project Project?     @relation(fields: [projectId], references: [id])
}

model BudgetItem {
  id          String  @id @default(cuid())
  projectId   String
  categoryId  String?
  // budgetCode  String  @unique
  description String // Contoh: Rental Mobil Operasional
  unit        String? // Contoh: Unit, Org, Lot, Bln
  quantity    Float? // Contoh: 2
  frequency   Int? // Contoh: 2 Bln
  duration    Int? // Contoh: 4 Bln (lama waktu)
  price       Int?

  project        Project         @relation(fields: [projectId], references: [id])
  budgetCategory BudgetCategory? @relation(fields: [categoryId], references: [id])

  @@unique([projectId, categoryId, description], name: "unique_item_per_project")
}

model ConfirmationOrder {
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  nomorCO             String                @unique
  tanggalCO           DateTime
  keterangan          String?
  status              Status                @default(PENDING)
  id                  Int                   @id @default(autoincrement())
  userId              Int?
  permintaanId        Int?
  vendorId            Int?
  confirmationDetails ConfirmationDetails[]
  permintaan          PermintaanLapangan?   @relation(fields: [permintaanId], references: [id])
  user                User?                 @relation(fields: [userId], references: [id])
  purchaseOrder       PurchaseOrder?        @relation("COToPO")
  vendor              Vendors?              @relation(fields: [vendorId], references: [id]) // ✅ Tambahan  
}

model PurchaseOrder {
  id                  Int               @id @default(autoincrement())
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  nomorPO             String            @unique
  tanggalPO           DateTime
  keterangan          String?
  confirmationOrderId Int               @unique
  userId              Int? // ✅ Tambahan
  purchaseDetails     PurchaseDetails[]
  confirmationOrder   ConfirmationOrder @relation("COToPO", fields: [confirmationOrderId], references: [id], onDelete: Cascade)
  user                User?             @relation(fields: [userId], references: [id])
  projectId           String?
  Project             Project?          @relation(fields: [projectId], references: [id])
}

model ConfirmationDetails {
  qty                 Int
  code                String
  keterangan          String?
  satuan              String
  status              Status            @default(PENDING)
  mention             String?
  id                  Int               @id @default(autoincrement())
  confirmationOrderId Int
  materialId          Int
  confirmationOrder   ConfirmationOrder @relation(fields: [confirmationOrderId], references: [id], onDelete: Cascade)
  material            Materials         @relation(fields: [materialId], references: [id], onDelete: Cascade)
}

model PermintaanDetails {
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  qty          Int
  satuan       String
  mention      String?
  code         String
  keterangan   String?
  status       Status             @default(PENDING)
  id           Int                @id @default(autoincrement())
  permintaanId Int
  materialName String
  permintaan   PermintaanLapangan @relation(fields: [permintaanId], references: [id], onDelete: Cascade)
}

model PurchaseDetails {
  qty             Int
  code            String
  satuan          String
  keterangan      String?
  status          Status        @default(IN_PROGRESS)
  id              Int           @id @default(autoincrement())
  purchaseOrderId Int
  materialId      Int
  material        Materials     @relation(fields: [materialId], references: [id], onDelete: Cascade)
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
}

model Materials {
  id                  Int                   @id @default(autoincrement())
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  image               String?
  name                String
  unit                String                @default("pcs")
  description         String
  price               Int
  categoryId          Int
  vendorId            Int
  code                String                @unique
  confirmationDetails ConfirmationDetails[]
  category            Categories            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  vendor              Vendors               @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  PurchaseDetails     PurchaseDetails[]
}

model Categories {
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  name      String      @unique
  id        Int         @id @default(autoincrement())
  materials Materials[]
}

model SignedBy {
  id           String     @id @default(uuid())
  signedFileId String
  userId       Int
  role         String
  signature    String
  createdAt    DateTime   @default(now())
  SignedFile   SignedFile @relation(fields: [signedFileId], references: [id])
  User         User       @relation(fields: [userId], references: [id])
}

model SignedFile {
  id        String     @id @default(uuid())
  type      FileType
  relatedId Int
  createdAt DateTime   @default(now())
  SignedBy  SignedBy[]

  @@unique([type, relatedId])
}

model SigningAuthority {
  id       String      @id @default(uuid())
  userId   Int
  fileType FileType
  role     SigningRole
  User     User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fileType, role])
}

enum Status {
  ACTIVE
  PENDING
  APPROVED
  REJECTED
  IN_PROGRESS // gunakan ini, hindari "PROCESSING" supaya tidak ambigu
  CLOSED
  CANCELLED
  READ
  COMPLETED
  ACC // jika tetap dibutuhkan
}

enum FileType {
  PERMINTAAN_LAPANGAN
  CONFIRMATION_ORDER
  PURCHASE_ORDER
}

enum SigningRole {
  ENGINEER_REQUESTER
  ENGINEER_CHECKER
  LOGISTIC
  PIC_LAPANGAN
  PURCHASING
  SITE_MANAGER
  VENDOR
  FINANCE
  DIREKSI
}

enum ProjectStatus {
  BERJALAN
  SELESAI
  TERTUNDA
  ONGOING
}

enum ProjectRole {
  PM
  PROCUREMENT
  STAFF
}
