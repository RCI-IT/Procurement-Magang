generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  schemas  = ["enum", "public", "auth", "project", "material", "procurement"]
}

/////////////////////////
// ENUM
/////////////////////////

enum ProjectStatus {
  PLANNING
  ONGOING
  HOLD
  COMPLETED
  CANCELLED

  @@schema("enum")
}

enum MRStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  COMPLETED

  @@schema("enum")
}

enum BoqType {
  MATERIAL
  LABOR
  EQUIPMENT
  OTHER

  @@schema("enum")
}

/////////////////////////
// Authentifikasi
/////////////////////////

model AuthUser {
  id        String         @id @default(uuid())
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  username  String         @unique
  password  String
  email     String         @unique
  roles     AuthUserRole[]

  employeeId String?
  // employee   HREmployee? @relation(fields: [employeeId], references: [id])

  // confirmationOrders ConfirmationOrder[]
  // PurchaseOrder      PurchaseOrder[]
  // SignedBy           SignedBy[]
  // SigningAuthority   SigningAuthority[]
  refreshTokens    RefreshToken[]
  materialRequests MaterialRequest[]
  approvals        Approval[]

  @@schema("auth")
}

model AuthRole {
  id        String   @id @default(uuid())
  roleName  String   @unique
  createdAt DateTime @default(now())

  users AuthUserRole[]

  @@schema("auth")
}

model AuthUserRole {
  id     String @id @default(uuid())
  userId String
  roleId String

  user AuthUser @relation(fields: [userId], references: [id])
  role AuthRole @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
  @@schema("auth")
}

model RefreshToken {
  id        String  @id @default(uuid())
  token     String  @unique
  userId    String
  userAgent String? // device
  ipAddress String? // optional

  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  user AuthUser @relation(fields: [userId], references: [id])

  @@schema("auth")
}

/////////////////////////////////////////////////////
// PROJECT SERVICE
/////////////////////////////////////////////////////

model Project {
  id          String          @id @default(uuid())
  projectName String
  code        String
  location    String
  owner       String
  contractNo  String
  startDate   DateTime        @db.Date
  endDate     DateTime        @db.Date
  members     ProjectMember[]
  // projectManager String

  // status         ProjectStatus
  // assignments    ProjectAssignment[]
  // purchaseOrders PurchaseOrder[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  rabs               Rab[]
  materialRequests   MaterialRequest[]
  projectAssignments ProjectAssignment[]

  @@schema("project")
}

model ProjectRole {
  id                 String              @id @default(uuid())
  roleName           String?
  members            ProjectMember[]
  projectAssignments ProjectAssignment[]

  @@schema("project")
}

model ProjectMember {
  id         String   @id @default(uuid())
  employeeId String
  projectId  String
  roleId     String
  joinedAt   DateTime @default(now())

  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  roleProject ProjectRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([projectId, roleId])
  @@schema("project")
}

/////////////////////////
// RAB (Budget) + BUDGET ITEMS (BOQ)
/////////////////////////

/// RAB as Budget header
model Rab {
  id          String   @id @default(cuid())
  projectId   String
  name        String? // contoh: "RAB Pekerjaan Pondasi"
  description String?
  totalBudget Decimal? @db.Decimal(18, 2) // dihitung dari BOQ
  createdBy   String?
  createdAt   DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  boqs    Boq[]

  @@schema("project")
}

model Boq {
  id          String   @id @default(cuid())
  rabId       String
  materialId  String? // opsional jika item berupa pekerjaan non-material
  description String // contoh: "Pekerjaan galian tanah" atau "Semen"
  unit        String?
  quantity    Float?
  price       Decimal? @db.Decimal(18, 2)
  // total       Decimal?    @db.Decimal(18,2) // quantity * price
  type        String

  rab      Rab                   @relation(fields: [rabId], references: [id], onDelete: Cascade)
  material Materials?            @relation(fields: [materialId], references: [id])
  mrItems  MaterialRequestItem[]

  @@schema("project")
}

/////////////////////////
// MATERIAL CATALOG
/////////////////////////

model Vendors {
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  id        String      @id @default(uuid())
  name      String
  address   String?
  city      String?
  phone     String?
  materials Materials[]

  @@schema("material")
}

model Categories {
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  name      String      @unique
  id        String      @id @default(uuid())
  materials Materials[]

  @@schema("material")
}

model Materials {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  image       String?
  name        String
  unit        String   @default("pcs")
  description String
  price       Decimal
  categoryId  String
  vendorId    String
  code        String   @unique

  category             Categories            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  vendor               Vendors               @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  boqs                 Boq[]
  materialRequestItems MaterialRequestItem[]

  @@schema("material")
}

/////////////////////////////////////////////////////
// PROCUREMENT SERVICE
/////////////////////////////////////////////////////

model MaterialRequest {
  id        String  @id @default(uuid())
  projectId String
  userId    String? // pembuat MR (AuthUser)

  requestDate DateTime

  // STATUS FLOW:
  // PENDING -> APPROVED -> PROCESSING -> DELIVERED -> RECEIVED -> COMPLETED
  // status      String  @default("PENDING")
  lokasi      String?
  picLapangan String?
  note        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creator   AuthUser?             @relation(fields: [userId], references: [id])
  project   Project               @relation(fields: [projectId], references: [id])
  detail    MaterialRequestItem[]
  purchases Purchase[]

  // TIMESTAMPS FOR FLOW
  approvedAt DateTime?
  // approval universaI (MR → Approval by documentId/documentType)
  approvals Approval[] @relation("MR_approvals")

  // proses item (partial processing)
  processing MRProcessing[]

  // pengiriman barang
  deliveries MRDelivery[]

  @@schema("procurement")
}

model MaterialRequestItem {
  id         String @id @default(uuid())
  mRequestId String

  // material yang diminta (WAJIB dari database)
  materialId String

  // harus berasal dari BOQ yang terkait
  boqId String

  qtyRequested Decimal
  unit         String
  // code
  notes        String?

  mr       MaterialRequest @relation(fields: [mRequestId], references: [id], onDelete: Cascade)
  material Materials       @relation(fields: [materialId], references: [id])
  boq      Boq             @relation(fields: [boqId], references: [id], onDelete: Cascade)

  processsing MRProcessingItem[]

  @@schema("procurement")
}

model Approval {
  id String @id @default(uuid())

  documentId   String // ID dokumen yang di-approve
  documentType String // MR, PO, GRN, PAYMENT, dll.

  approverId String //User yang memutuskan 
  level      Int // level approval (1, 2, 3, ...)
  status     String // APPROVED / REJECTED / PENDING

  note      String?
  decidedAt DateTime? @default(now())

  approver AuthUser @relation(fields: [approverId], references: [id])

  @@schema("procurement")
}

model MRProcessing {
  id         String @id @default(uuid())
  mRequestId String
  processedBy String //Id employee atau user
  processedAt DateTime @default(now())

  mr MaterialRequest @relation(fields: [mRequestId], references: [id])
  items MRProcessingItem[]

  @@schema("procurement")
}

model MRProcessingItem {
  id        String @id @default(uuid())
  processingId String
  mrItemId     String
  qtyProcessed Float

  processing MRProcessing @relation(fields: [processingId], references: [id])
  mrItem     MaterialRequestItem @relation(fields: [mrItemId], references: [id])
}

model Purchase {
  id            Int       @id @default(autoincrement())
  mr_id         String
  vendor_id     Int
  purchase_date DateTime?
  qty_purchased Decimal?
  total_price   Decimal?
  created_at    DateTime? @default(now())

  mr MaterialRequest @relation(fields: [mr_id], references: [id], onDelete: Cascade)
  // vendor Vendor          @relation(fields: [vendor_id], references: [id], onDelete: Cascade)

  @@schema("procurement")
}

model ProjectAssignment {
  id            String      @id @default(cuid())
  employeeId    String // Foreign key dari backend karyawan
  projectId     String
  roleInProject ProjectRole @relation(fields: [projectRoleId], references: [id])

  project       Project  @relation(fields: [projectId], references: [id])
  createdAt     DateTime @default(now())
  projectRoleId String

  @@unique([employeeId, projectId])
  @@schema("procurement")
}

// model ConfirmationOrder {
//   createdAt           DateTime              @default(now())
//   updatedAt           DateTime              @updatedAt
//   nomorCO             String                @unique
//   tanggalCO           DateTime
//   keterangan          String?
//   status              Status                @default(PENDING)
//   id                  Int                   @id @default(autoincrement())
//   userId              Int?
//   permintaanId        Int?
//   vendorId            Int?
//   confirmationDetails ConfirmationDetails[]
//   permintaan          PermintaanLapangan?   @relation(fields: [permintaanId], references: [id])
//   user                User?                 @relation(fields: [userId], references: [id])
//   purchaseOrder       PurchaseOrder?        @relation("COToPO")
//   vendor              Vendors?              @relation(fields: [vendorId], references: [id]) // ✅ Tambahan  
// }

// model PurchaseOrder {
//   id                  Int               @id @default(autoincrement())
//   createdAt           DateTime          @default(now())
//   updatedAt           DateTime          @updatedAt
//   nomorPO             String            @unique
//   tanggalPO           DateTime
//   keterangan          String?
//   confirmationOrderId Int               @unique
//   userId              Int? // ✅ Tambahan
//   purchaseDetails     PurchaseDetails[]
//   confirmationOrder   ConfirmationOrder @relation("COToPO", fields: [confirmationOrderId], references: [id], onDelete: Cascade)
//   user                User?             @relation(fields: [userId], references: [id])
//   projectId           String?
//   Project             Project?          @relation(fields: [projectId], references: [id])
// }

// model ConfirmationDetails {
//   qty                 Int
//   code                String
//   keterangan          String?
//   satuan              String
//   status              Status            @default(PENDING)
//   mention             String?
//   id                  Int               @id @default(autoincrement())
//   confirmationOrderId Int
//   materialId          Int
//   confirmationOrder   ConfirmationOrder @relation(fields: [confirmationOrderId], references: [id], onDelete: Cascade)
//   material            Materials         @relation(fields: [materialId], references: [id], onDelete: Cascade)
// }

// model PurchaseDetails {
//   qty             Int
//   code            String
//   satuan          String
//   keterangan      String?
//   status          Status        @default(IN_PROGRESS)
//   id              Int           @id @default(autoincrement())
//   purchaseOrderId Int
//   materialId      Int
//   material        Materials     @relation(fields: [materialId], references: [id], onDelete: Cascade)
//   purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
// }

// model SignedBy {
//   id           String     @id @default(uuid())
//   signedFileId String
//   userId       Int
//   role         String
//   signature    String
//   createdAt    DateTime   @default(now())
//   SignedFile   SignedFile @relation(fields: [signedFileId], references: [id])
//   User         User       @relation(fields: [userId], references: [id])
// }

// model SignedFile {
//   id        String     @id @default(uuid())
//   type      FileType
//   relatedId Int
//   createdAt DateTime   @default(now())
//   SignedBy  SignedBy[]

//   @@unique([type, relatedId])
// }

// model SigningAuthority {
//   id       String      @id @default(uuid())
//   userId   Int
//   fileType FileType
//   role     SigningRole
//   User     User        @relation(fields: [userId], references: [id], onDelete: Cascade)

//   @@unique([userId, fileType, role])
// }

// enum Status {
//   ACTIVE
//   PENDING
//   APPROVED
//   REJECTED
//   IN_PROGRESS // gunakan ini, hindari "PROCESSING" supaya tidak ambigu
//   CLOSED
//   CANCELLED
//   READ
//   COMPLETED
//   ACC // jika tetap dibutuhkan
// }

// enum FileType {
//   PERMINTAAN_LAPANGAN
//   CONFIRMATION_ORDER
//   PURCHASE_ORDER
// }

// enum SigningRole {
//   ENGINEER_REQUESTER
//   ENGINEER_CHECKER
//   LOGISTIC
//   PIC_LAPANGAN
//   PURCHASING
//   SITE_MANAGER
//   VENDOR
//   FINANCE
//   DIREKSI
// }

// enum ProjectStatus {
//   BERJALAN
//   SELESAI
//   TERTUNDA
//   ONGOING
// }
